package com.cultome.bizlang.language.function;

import static org.junit.Assert.*;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.junit.Before;
import org.junit.Test;

import com.cultome.bizlang.dataaccess.WSReader;
import com.cultome.bizlang.language.BizlangException;
import com.cultome.bizlang.language.BizlangValue;
import com.cultome.bizlang.language.parser.BizlangLexer;
import com.cultome.bizlang.language.util.Utils;
import com.cultomebizlang.language.interpreter.Bindings;

public class GetFromWsFunctionTest {
	
	private GetFromWsFunction function;
	private Bindings bindings;

	@Before
	public void setUp() throws Exception {
		function = new GetFromWsFunction();
		bindings = new Bindings();
		bindings.addBinding("resourceName", "token");
		bindings.addBinding("token", "mytoken");
		
		Map<String, Object> wsConfig = new HashMap<String, Object>();
		HashMap<String, String> headers = new HashMap<String, String>();
		headers.put("BIZLANG_TOKEN", "{token}");
		
		wsConfig.put(GetFromWsFunction.ENDPOINT_PROPERTY, "http://localhost:8080/bizlang-ws/{resourceName}s");
		wsConfig.put(GetFromWsFunction.HTTP_METHOD_PROPERTY, "gEt");
//		wsConfig.put(GetFromWsFunction.CONTENT_PROPERTY, null);
		wsConfig.put(GetFromWsFunction.HEADERS_PROPERTY, headers);
		
		bindings.addConfig(Bindings.CNFG_NS_WEBSERVICES, GetFromWsFunction.ACCESSOR, WSReader.getInstance());
		bindings.addConfig(Bindings.CNFG_NS_WEBSERVICES, "myWs", wsConfig);
	}

	@SuppressWarnings("unchecked")
	@Test
	public void testExecute() throws BizlangException {
		Map<String, Object> r = (Map<String, Object>) function.execute(bindings, new BizlangValue(BizlangLexer.STR, "myWs", 1));
		assertNotNull(r);
		assertEquals(new BigDecimal(1), (BigDecimal) Utils.getPropertyFrom(r, "tokens.token[0].id"));
	}
	
	@SuppressWarnings("rawtypes")
	@Test
	public void testParseXml(){
		String xml = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><tokens><token><resource_type>TOKEN</resource_type><created_at>2014-02-11T13:00:00-06:00</created_at><duration_sec>2592000</duration_sec><id>1</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>mytoken</token></token><token><resource_type>TOKEN</resource_type><created_at>2013-02-11T13:00:00-06:00</created_at><duration_sec>600</duration_sec><id>2</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>expired</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-11T13:00:00-06:00</created_at><duration_sec>2592000</duration_sec><id>4</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>noauths</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-17T17:45:56-06:00</created_at><duration_sec>50</duration_sec><id>5</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:44:12-06:00</created_at><duration_sec>100</duration_sec><id>510965786</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:01:18-06:00</created_at><duration_sec>100</duration_sec><id>964151326</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:23:32-06:00</created_at><duration_sec>100</duration_sec><id>1169038681</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:59:25-06:00</created_at><duration_sec>100</duration_sec><id>1412991672</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-17T17:45:56-06:00</created_at><duration_sec>100</duration_sec><id>1495727184</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-17T17:46:09-06:00</created_at><duration_sec>108000</duration_sec><id>1495727185</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>4466131fe67645cc7da0991edad1518b412f51f6</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:56:24-06:00</created_at><duration_sec>50</duration_sec><id>1495727186</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:23:40-06:00</created_at><duration_sec>100</duration_sec><id>1496501699</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:06:01-06:00</created_at><duration_sec>100</duration_sec><id>1784532418</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:56:24-06:00</created_at><duration_sec>100</duration_sec><id>1896764415</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:56:33-06:00</created_at><duration_sec>108000</duration_sec><id>1896764416</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>ed4abaf90147384fe86ed040f9a79a9c1cf8bd8a</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:56:33-06:00</created_at><duration_sec>108000</duration_sec><id>1896764417</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>4fc7cd5c92ff54b16963a4e2ea484ace67d65886</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:56:37-06:00</created_at><duration_sec>108000</duration_sec><id>1896764418</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>4b63d71059bd2eca74622b6a80eb829c72a27e75</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:59:25-06:00</created_at><duration_sec>50</duration_sec><id>1896764419</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:59:35-06:00</created_at><duration_sec>108000</duration_sec><id>1896764420</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>67a14552edadd5075c5cdea17bf3a6249d9c6b84</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:59:36-06:00</created_at><duration_sec>108000</duration_sec><id>1896764421</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>1509ea04b5eea13a8e884ffed19339c2f964b3cc</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T10:59:40-06:00</created_at><duration_sec>108000</duration_sec><id>1896764422</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>29cbcc2701b7b13d15ff14b3dfac7c7398b22899</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:01:18-06:00</created_at><duration_sec>50</duration_sec><id>1896764423</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:01:29-06:00</created_at><duration_sec>108000</duration_sec><id>1896764424</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>fdf79669271cacf3faf7bd087c25b2a94e9b4026</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:01:29-06:00</created_at><duration_sec>108000</duration_sec><id>1896764425</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>c085436391416d88d5166ea2d7dd4338dcd992bb</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:01:34-06:00</created_at><duration_sec>108000</duration_sec><id>1896764426</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>403727f609cf2c5065e101709e155e4512d4e67e</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:44:12-06:00</created_at><duration_sec>50</duration_sec><id>1896764427</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:44:25-06:00</created_at><duration_sec>108000</duration_sec><id>1896764428</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>0e24be17d9abdf9a5ac2141b0454a1240c2bd632</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:44:25-06:00</created_at><duration_sec>108000</duration_sec><id>1896764429</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>5cfafd1dfe2c76cf9a789ad791ba0227149a33e7</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-18T13:44:32-06:00</created_at><duration_sec>108000</duration_sec><id>1896764430</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>382ae2ff848cee31c5502d42dc51b8180522662b</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:05:29-06:00</created_at><duration_sec>50</duration_sec><id>1896764431</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:05:29-06:00</created_at><duration_sec>100</duration_sec><id>2051242261</id><requestor><resource_type>USER</resource_type><display_name>Carlos Soria</display_name><id>2</id><password>3749424d231afb107c5d61b71fd2b836ee77fd81</password><username>csoria</username></requestor><system><resource_type>SYSTEM</resource_type><description>El servidor de desarrollo</description><id>2</id><ip>127.0.0.1</ip><name>idlas50</name></system><token>new token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:05:34-06:00</created_at><duration_sec>108000</duration_sec><id>2051242262</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>aa23cba40fd2f0471a0398367a658307848fcd2c</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:06:01-06:00</created_at><duration_sec>50</duration_sec><id>2051242263</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:06:17-06:00</created_at><duration_sec>108000</duration_sec><id>2051242264</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>6f62132500fb37445d53af42ccd06d2a9db48346</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:06:17-06:00</created_at><duration_sec>108000</duration_sec><id>2051242265</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>869601e156896076ccfc314bc4c9654c93335746</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:06:24-06:00</created_at><duration_sec>108000</duration_sec><id>2051242266</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>4e4a7958a62bbf415e45dc2d4be20630d8a099e0</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:23:32-06:00</created_at><duration_sec>50</duration_sec><id>2051242267</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:23:35-06:00</created_at><duration_sec>108000</duration_sec><id>2051242268</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>fbd4fd2b27505a286a16e66819da8d9b825fe237</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:23:40-06:00</created_at><duration_sec>50</duration_sec><id>2051242269</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>token</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:23:57-06:00</created_at><duration_sec>108000</duration_sec><id>2051242270</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>038b43ec3df560d2d84d9a7cddc78f5a0c152c72</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:23:57-06:00</created_at><duration_sec>108000</duration_sec><id>2051242271</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>de76af1ee2b1dc209cc6d2ad1c468bcedee56f1f</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:24:05-06:00</created_at><duration_sec>108000</duration_sec><id>2051242272</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>2e770a7f50e57da924ee88f9cbea2ce1632c7826</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:24:30-06:00</created_at><duration_sec>108000</duration_sec><id>2051242273</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>5e50df6106a0611adc5330f3148572fe285e8eef</token></token><token><resource_type>TOKEN</resource_type><created_at>2014-02-19T11:24:31-06:00</created_at><duration_sec>108000</duration_sec><id>2051242274</id><requestor><resource_type>USER</resource_type><display_name>Administrador</display_name><id>1</id><password>7c6ccedb19f2947edfadec240c12554152449e0e</password><username>admin</username></requestor><system><resource_type>SYSTEM</resource_type><description>Mi maquina local</description><id>1</id><ip>127.0.0.1</ip><name>localhost</name></system><token>c842abf72aedc31af31f899b8f823d6febedf26c</token></token></tokens>";
		Map<String, Object> r = function.parseXml(xml);
		assertNotNull(r);
		Object tokens = ((Map) r.get("tokens")).get("token");
		assertTrue(tokens instanceof List);
		Object token = ((List) tokens).get(0);
		assertTrue(token instanceof Map);
		assertEquals("TOKEN", ((Map) token).get("resource_type"));
		Object system = ((Map) token).get("system");
		assertTrue(system instanceof Map);
		assertEquals("127.0.0.1", ((Map) system).get("ip"));
	}
	
	@Test
	public void testParseNestedRoutesBig(){
		List<String> expandedRoutes = Arrays.asList("tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token","tokens.token.resource_type","tokens.token.created_at","tokens.token.duration_sec","tokens.token.id","tokens.token.requestor.resource_type","tokens.token.requestor.display_name","tokens.token.requestor.id","tokens.token.requestor.password","tokens.token.requestor.username","tokens.token.system.resource_type","tokens.token.system.description","tokens.token.system.id","tokens.token.system.ip","tokens.token.system.name","tokens.token.token");
		Map<String, String> nestedRoutes = function.parseNestedRoutes(expandedRoutes);
		assertNotNull(nestedRoutes);
	}
	
	@Test
	public void testParseNestedRoutes(){
		List<String> expandedRoutes = new ArrayList<String>();
		expandedRoutes.add("uno.dos.tres.cuatro.cinco");
		expandedRoutes.add("uno.dos.tres.cuatro.seis");
		expandedRoutes.add("uno.dos.tres.cuatro.cinco");
		expandedRoutes.add("uno.dos.tres.cuatro.seis");
		expandedRoutes.add("uno.dos.tres.cuatro.siete");
		expandedRoutes.add("uno.dos.tres.cinco.cuatro");
		expandedRoutes.add("uno.dos.tres.cinco.cuatro");
		expandedRoutes.add("uno.tres");
		expandedRoutes.add("uno.tres");
		expandedRoutes.add("uno.cuatro");
		expandedRoutes.add("uno.cinco.seis.siete");
		expandedRoutes.add("uno.cinco.seis.siete");
		expandedRoutes.add("uno.cinco.seis.ocho");
		Map<String, String> nestedRoutes = function.parseNestedRoutes(expandedRoutes);
		//uno.cinco.seis.ocho
		//uno.tres[]
		//uno.dos[].tres.cuatro.seis
		//uno.dos[].tres.cuatro.cinco
		//uno.dos[].tres.cinco.cuatro
		//uno.dos.tres.cuatro.siete
		//uno.cuatro
		//uno.cinco[].seis.siete
		// TODO terminar esta prueba
		assertNotNull(nestedRoutes);
	}
	
	@Test
	public void testRemoveLastNestIndication(){
		assertEquals("uno.dos.tres.cuatro[].cinco", function.removeLastNestIndication("uno.dos.tres.cuatro[].cinco[]"));
		assertEquals("uno.dos.tres[].cuatro.cinco", function.removeLastNestIndication("uno.dos.tres[].cuatro.cinco[]"));
		assertEquals("uno.dos[].tres.cuatro.cinco", function.removeLastNestIndication("uno.dos[].tres.cuatro[].cinco"));
		assertEquals("uno[].dos.tres.cuatro.cinco", function.removeLastNestIndication("uno[].dos.tres.cuatro.cinco[]"));
		assertEquals("uno.dos[].tres.cuatro.cinco", function.removeLastNestIndication("uno.dos[].tres[].cuatro.cinco"));
	}
		
	@Test
	public void testInsertNestedLevel(){
		assertEquals("uno[].dos.tres.cuatro.cinco", function.insertNestedLevel("uno.dos.tres.cuatro.cinco", 0));
		assertEquals("uno.dos[].tres.cuatro.cinco", function.insertNestedLevel("uno.dos.tres.cuatro.cinco", 1));
		assertEquals("uno.dos.tres[].cuatro.cinco", function.insertNestedLevel("uno.dos.tres.cuatro.cinco", 2));
		assertEquals("uno.dos.tres.cuatro[].cinco", function.insertNestedLevel("uno.dos.tres.cuatro.cinco", 3));
		assertEquals("uno.dos.tres.cuatro.cinco[]", function.insertNestedLevel("uno.dos.tres.cuatro.cinco", 4));
		assertEquals("uno.dos.tres.cuatro.cinco", function.insertNestedLevel("uno.dos.tres.cuatro.cinco", 5));
	}
	
	@Test
	public void testGetLevelName(){
		assertEquals("uno", function.getLevelName("uno.dos.tres.cuatro.cinco", 0));
		assertEquals("dos", function.getLevelName("uno.dos.tres.cuatro.cinco", 1));
		assertEquals("tres", function.getLevelName("uno.dos.tres.cuatro.cinco", 2));
		assertEquals("cuatro", function.getLevelName("uno.dos.tres.cuatro.cinco", 3));
		assertEquals("cinco", function.getLevelName("uno.dos.tres.cuatro.cinco", 4));
		assertNull(function.getLevelName("uno.dos.tres.cuatro.cinco", 5));
	}
	
	@Test
	public void testCountLevels(){
		assertEquals(0, function.countLevels("uno"));
		assertEquals(1, function.countLevels("uno.dos"));
		assertEquals(2, function.countLevels("uno.dos.tres"));
		assertEquals(3, function.countLevels("uno.dos.tres.cuatro"));
	}

}
